<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員管理</title>
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.min.css">
    <link rel="stylesheet" href="css/myall.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
</head>
<body>
    <!-- 選單 -->
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">控制台</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" href="#">Home</a>
              </li>
              <li class="nav-item d-none me-2" id="s02_login_icon">
                <span class="h3 text-color02"><i class="fa-solid fa-user"></i> <span class="h5" id="login_username_message"></span></span>
            </li>
              <li class="nav-item d-none" id="s02_logout_button">
                <a class="nav-link" href="#" data-bs-toggle="modal"><i class="fa-solid fa-right-from-bracket me-2"></i>登出</a>
            </li>
            </ul>
            <form class="d-flex" role="search">
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
          </div>
        </div>
      </nav>
    <!--麵包屑-->
    <div class="row">
        <div class="col-12 d-flex justify-content-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb ">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">會員管理</li>
                </ol>
            </nav> 
        </div>
    </div>
    <!-- table -->
    <div class="container my-2 d-none" id="member_table">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <!-- table-rwd 建立於myall.css裡的 -->
                        <table class="table table-bordered table-striped table-rwd table-hover ">
                            <thead>
                                <tr class="text-bg-secondary fw-100 h5 align-middle text-center">
                                    <th>會員編號</th>
                                    <th>會員名稱</th>
                                    <th>會員等級</th>
                                    <th>會員email</th>
                                    <th>會員生日</th>
                                    <th>會員狀態</th>
                                    <th>建檔時間</th>
                                    <th>更新/刪除</th>
                                </tr>
                            </thead>
                            <tbody id="datalist" class="align-middle text-center">
                                <tr>
                                    <td data-th="會員編號"><span class="table-col align-content-center">001</span></td>
                                    <td data-th="會員名稱"><span class="table-col">1</span></td>
                                    <td data-th="會員等級">
                                        <select name="level" id="level" class="form-select">
                                            <option value="0"selected>一般會員</option>
                                            <option value="100">VIP01</option>
                                            <option value="200">VIP02</option>
                                            <option value="300">VIP03</option>
                                            <option value="900">管理員</option>
                                        </select>
                                    </td>
                                    <td data-th="會員email"><span class="table-col">100</span></td>
                                    <td data-th="會員生日"><span class="table-col">10</span></td>
                                    <td data-th="會員狀態">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" checked id="state_switch" name="state_switch" data-state="X">
                                            <label for="state_switch" class="form-check-label">啟用</label>
                                        </div>
                                    </td>
                                    <td data-th="建檔時間"><span class="table-col">2024718</span></td>
                                    <td >
                                      <button class="btn btn-info me-2" type="button" data-bs-toggle="modal" data-bs-target="#updateModal" data-id="XX" data-username="XX" data-email="XX" data-birthday="XX" data-created_at="XX" id="btn_update">更新</button>
                                      <button class="btn btn-danger" id="btn_delete" data-id="xx">刪除</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <nav aria-label="Page navigation example">
                <ul class="pagination pagination-lg justify-content-center " id="pagelist">
                  <li class="page-item disabled"><a class="page-link" href="#" tabindex="-1" aria-disabled="true">上一頁</a></li>
                  <li class="page-item"><a class="page-link" href="#">1</a></li>
                  <li class="page-item"><a class="page-link" href="#">2</a></li>
                  <li class="page-item"><a class="page-link" href="#">3</a></li>
                  <li class="page-item"><a class="page-link" href="#">下一頁</a></li>
                </ul>
              </nav>
        </div>
      </div>
    <!-- updateModal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable ">
          <div class="modal-content">
            <div class="modal-header text-bg-info">
              <h5 class="modal-title" id="updateModal">會員更新</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="update_username" class="form-label">帳號</label>
                    <input type="text" class="form-control disabled" id="update_username" name="update_username" disabled placeholder="">
                </div>
                <div class="mb-3">
                    <label for="update_datepicker" class="form-label">生日</label>
                    <input type="text" class="form-control hiding" id="update_datepicker" name="update_datepicker" readonly>
                    <div class="valid-feedback">符合規定</div>
                    <div class="invalid-feedback">不符合規定</div>
                </div>
                <div class="mb-3">
                    <label for="update_email" class="form-label">email</label>
                    <input type="text" class="form-control hiding" id="update_email" name="update_email" placeholder="僅可使用gmail">
                    <div class="valid-feedback">符合規定</div>
                    <div class="invalid-feedback">請輸入gmail</div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="btn_update_ok">更新</button>
            </div>
          </div>
        </div>
      </div>
</body>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery-3.7.1.min.js"></script>
<script src="js/sweetalert2@11.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
    var flag_datepicker = true;
    var flag_email = true;
    var u_id;
    var newdata=[];

    //正規表達式
        //密碼
        const rules_pwd = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/ ;
        //email
        const rules_email= /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    $(function(){
        if(getCookie("uid01")!=""){
                //將uid傳遞至後端api確認是否合法
                var dataJSON = {};
                    dataJSON["uid01"] = getCookie("uid01");
                    // console.log(JSON.stringify(dataJSON));
                    $.ajax({
                        type:"POST",
                        url:"API/member_login_check_uid_api.php",
                        data:JSON.stringify(dataJSON),
                        dataType:"json",
                        success:showdata_check_uid,
                        error:function(){
                            alert("error-member_login_check_uid_api.php");
                        }
                    });
            }else{
                location.href = "index.html";
            };

        //監聽登出按鈕
        $("#s02_logout_button").click(function(){
                //將cookie設為空值
                setCookie("uid01","",7);
                //重整
                location.reload();
            })

        
        
    })//end of function
    //登入
    function showdata_check_uid(data){
            console.log(data);
                //顯示登入帳號
                if(data.state){
                    if(data.data.Level=="900"){
                        $("#login_username_message").text(data.data.Username+"您好");
                        //顯示登出按鈕
                        $("#s02_logout_button").removeClass("d-none");
                        $("#s02_login_icon").removeClass("d-none");
                        //
                        $("#member_table").removeClass("d-none");

                        //讀取會員資料
                        $.ajax({
                            type:"GET",
                            url:"API/member_read_api.php",
                            dataType:"json",
                            success:showdata_read,
                            error:function(){
                                alert("error_member_read_api.php");
                            }
                        });
                    }else{
                        Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "管理員專用",
                        }).then((result)=>{
                            if (result.isConfirmed) {
                                location.href = "index.html";
                            }  
                        })
                    }
                    
                }
        };
    //讀取member資料
    function showdata_read(data){
        console.log(data);
        //重構data 產生newdata
        data.data.forEach(function(item,key){
             //console.log(key);
            //  console.log(item);
            if(key % 10 ==0){
                newdata.push([]);
            }
            var page = parseInt(key/10);
            newdata[page].push(item);
        });
        console.log(newdata);

        drawTable(0);

        

        //監聽update_datepicker
        $("#update_datepicker").bind("change" , function(){
                if($(this).val()!=" "){
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_datepicker = true;
                }else{
                    //不符合規定
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    flag_datepicker = false;
                }
            });

        //監聽update_email
        $("#update_email").bind("input propertychange" , function(){
        if(rules_email.test($(this).val())){
            $(this).removeClass("is-invalid");
            $(this).addClass("is-valid");
            flag_email = true;
        }else{
            //不符合規定
            $(this).removeClass("is-valid");
            $(this).addClass("is-invalid");
            flag_email = false;
        }
        });
        //監聽更新modal
        $("#btn_update_ok").click(function(){
            if(flag_email && flag_datepicker){
                var dataJSON = {};
                dataJSON["id"] = u_id;
                dataJSON["email"]    = $("#update_email").val();
                dataJSON["birthday"] = $("#update_datepicker").val();
                console.log(JSON.stringify(dataJSON));
                $.ajax({
                    type:"POST",
                    url:"API/member_update_api.php",
                    data:JSON.stringify(dataJSON),
                    dataType:"json",
                    success:showdata_update,
                    error:function(){
                        alert("error-member_update_api.php");
                    }
                });
            }else{
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "欄位有誤請修正",
                    });
            }
        });

    };
    //確認更新update
    function showdata_update(data){
        console.log(data);
        if(data.state){
            Swal.fire({
                title: "Good job!",
                text: data.message,
                icon: "success",
                }).then((result) => {
                if (result.isConfirmed) {
                    // 重整頁面
                    location.reload();
                }
            });
        }
    };
    //渲染table
    function drawTable(page){
        //渲染table 產生會員資料
        $("#datalist").empty();
        newdata[page].forEach(function(item){
            
            //判斷會員等級
            if(item.Level==0){
                strLEVEL ='<td data-th="會員等級"><select name="level" id="level" class="form-select" data-id="'+item.ID+'"><option value="0" selected>一般會員</option><option value="100">VIP01</option><option value="200">VIP02</option><option value="300">VIP03</option><option value="900">管理員</option></select></td>'
            }else if(item.Level==100){
                strLEVEL ='<td data-th="會員等級"><select name="level" id="level" class="form-select" data-id="'+item.ID+'"><option value="0">一般會員</option><option value="100" selected>VIP01</option><option value="200">VIP02</option><option value="300">VIP03</option><option value="900">管理員</option></select></td>'
            }else if(item.Level==200){
                strLEVEL ='<td data-th="會員等級"><select name="level" id="level" class="form-select" data-id="'+item.ID+'"><option value="0">一般會員</option><option value="100">VIP01</option><option value="200" selected>VIP02</option><option value="300">VIP03</option><option value="900">管理員</option></select></td>'
            }else if(item.Level==300){
                strLEVEL ='<td data-th="會員等級"><select name="level" id="level" class="form-select" data-id="'+item.ID+'"><option value="0">一般會員</option><option value="100">VIP01</option><option value="200">VIP02</option><option value="300" selected>VIP03</option><option value="900">管理員</option></select></td>'
            }else{
                strLEVEL ='<td data-th="會員等級"><select name="level" id="level" class="form-select" data-id="'+item.ID+'"><option value="0">一般會員</option><option value="100">VIP01</option><option value="200">VIP02</option><option value="300">VIP03</option><option value="900" selected>管理員</option></select></td>'
            }

            var strHTML = '<tr><td data-th="會員編號"><span class="table-col align-content-center">'+item.ID+'</span></td><td data-th="會員名稱"><span class="table-col">'+item.Username+'</span></td>'+strLEVEL+'<td data-th="會員email"><span class="table-col">'+item.Email+'</span></td><td data-th="會員生日"><span class="table-col">'+item.Birthday+'</span></td><td data-th="會員狀態"><div class="form-check form-switch"><input type="checkbox" class="form-check-input" '+(item.State == "1" ? 'checked':'')+' id="state_switch" name="state_switch" data-id="'+item.ID+'" data-state="'+item.State+'"><label for="" class="form-check-label '+(item.State == "1" ? 'text-success':'text-danger')+'">'+(item.State == "1" ? '啟用':'停用')+'</label></div></td><td data-th="建檔時間"><span class="table-col">'+item.Created_at+'</span></td><td ><button class="btn btn-info me-2" type="button" data-bs-toggle="modal" data-bs-target="#updateModal" data-id="'+item.ID+'"data-username="'+item.Username+'"data-email="'+item.Email+'" data-birthday="'+item.Birthday+'" data-created_at="'+item.Created_at+'" id="btn_update">更新</button><button class="btn btn-danger" id="btn_delete" data-id="'+item.ID+'">刪除</button></td></tr>'
            $("#datalist").append(strHTML);
        });

        //上一頁按鈕
        $("#pagelist").empty();
        var previousPage = page-1;
        if (previousPage < 0) {
            previousPage = 0; // 防止頁數超出範圍
        };
        // var strPREVIOUS;
        // if(page==0){
        //     strPREVIOUS='<li class="page-item disabled" onclick="drawTable(' + previousPage + ')"><a class="page-link" href="#">上一頁</a></li>'
        // }else{
        //     strPREVIOUS='<li class="page-item " onclick="drawTable(' + previousPage + ')"><a class="page-link" href="#">上一頁</a></li>'
        // }
        // $("#pagelist").append(strPREVIOUS);
        
        //可簡寫為一行
        // condition ? value_if_true : value_if_false
        //if page==0 則加入字串'disable' , 否則加入'空白'

         $("#pagelist").append('<li class="page-item ' + (page == 0 ? 'disabled' : '') + '" onclick="drawTable(' + previousPage + ')"><a class="page-link" href="#">上一頁</a></li>');

        //產生頁碼
        for(var i=0;i<newdata.length;i++){
            var thisPage = i+1;
            var anotherPage = thisPage-1;
            var strHTML;
            if(thisPage==page+1){
                strHTML='<li class="page-item active" onclick = "drawTable('+anotherPage+')"><a class="page-link" href="#">'+thisPage+'</a></li>';
            }else{
                strHTML='<li class="page-item" onclick = "drawTable('+anotherPage+')"><a class="page-link" href="#">'+thisPage+'</a></li>';
            }
            $("#pagelist").append(strHTML);
        };

        //下一頁按鈕
        var nextPage = page+1;
        if (nextPage >= newdata.length) {
            nextPage =  newdata.length-1; // 防止頁數超出範圍
        };
        $("#pagelist").append('<li class="page-item ' + (page == (newdata.length-1) ? 'disabled' : '') + '" onclick="drawTable(' + nextPage + ')"><a class="page-link" href="#">下一頁</a></li>');

        //監聽update按鈕
        $("#datalist #btn_update").click(function(){
            console.log($(this).data("id"));
            console.log($(this).data("username"));
            console.log($(this).data("email"));
            console.log($(this).data("birthday"));
            console.log($(this).data("created_at"));

            $("#update_username").val($(this).data("username"));
            $("#update_datepicker").val($(this).data("birthday"));
            $("#update_email").val($(this).data("email"));
            u_id = $(this).data("id");
        });

        //監聽delete按鈕
        $("#datalist #btn_delete").click(function(){
            console.log($(this).data("id"));
            Swal.fire({
                title: "確定要刪除嗎",
                showDenyButton: true,
                confirmButtonText: "確定",
                denyButtonText: `取消`,
                icon: "warning",
                }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed){
                    Swal.fire({
                    title: "刪除用戶?",
                    showCancelButton: true,
                    text: "真的確定要刪除嗎",
                    icon: "warning"
                    }).then((result)=>{
                        if (result.isConfirmed) {
                            //傳遞id後端api,執行刪除功能
                            var dataJSON = {};
                            dataJSON["id"] = $(this).data("id");
                            console.log(JSON.stringify(dataJSON));
                            $.ajax({
                                type:"POST",
                                url:"API/member_delete_api.php",
                                data:JSON.stringify(dataJSON),
                                dataType:"json",
                                success:showdata_member_delete,
                                error:function(){
                                    alert("error-member_delete_api.php");
                                }
                            });
                        }   
                    })
                } else if (result.isDenied) {
                    Swal.fire("已取消", "", "info");
                }
            }); 
        });

        //監聽state_switch 會員狀態按鈕
        $("#datalist #state_switch").change(function(){
            console.log($(this).is(":checked"));
            console.log($(this).data("id"));
            if($(this).is(":checked")){
                $(this).next().text("啟用");
                $(this).next().removeClass("text-danger");
                $(this).next().addClass("text-success");
            }else{
                $(this).next().text("停用");
                $(this).next().removeClass("text-success");
                $(this).next().addClass("text-danger");
            }

            //傳遞至後端更新帳號資料
            var dataJSON = {};
                ($(this).is(":checked") ? mystate= "1" : mystate = "0");
                dataJSON["id"] = $(this).data("id");
                dataJSON["state"] = mystate;
            
                console.log(JSON.stringify(dataJSON));
                $.ajax({
                    type:"POST",
                    url:"API/member_update_state_api.php",
                    data:JSON.stringify(dataJSON),
                    dataType:"json",
                    success:showdata_member_update_state,
                    error:function(){
                        alert("error-member_update_state_api.php");
                    }
                });

        });
        //監聽level 會員狀等級選單
        $("#datalist #level").change(function(){
            console.log($(this).val());
            console.log($(this).data("id"));

            //傳遞至後端更新帳號資料
            var dataJSON = {};
                dataJSON["id"] = $(this).data("id");
                dataJSON["level"] = $(this).val();
            
            console.log(JSON.stringify(dataJSON));
            $.ajax({
                type:"POST",
                url:"API/member_update_level_api.php",
                data:JSON.stringify(dataJSON),
                dataType:"json",
                success:showdata_member_update_level,
                error:function(){
                    alert("error-member_update_level_api.php");
                }
            });
        });
        
    };

    function showdata_member_delete(data){
        console.log(data);
        if(data.state){
            Swal.fire({
                title: "刪除成功",
                text: data.message,
                icon: "success",
                }).then((result) => {
                if (result.isConfirmed) {
                    // 重整頁面
                    location.reload();
                }
            });
        }
    };

    function showdata_member_update_state(data){
        console.log(data);
        if(data.state){
            Swal.fire({
                title: "更改成功",
                text: data.message,
                icon: "success",
                })
        }
    }
    function showdata_member_update_level(data){
        console.log(data);
        if(data.state){
            Swal.fire({
                title: "更改成功",
                text: data.message,
                icon: "success",
                })
        }
    }
    


    //**************cookie function from w3*****************
    function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }

        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
                }
            }
            return "";
            }
</script>
 <!-- datepicker -->
 <script>
    $(document).ready(function() {
      $('#update_datepicker').datepicker({
            format :'yyyy-mm-dd'
      });
    });
  </script>
</html>