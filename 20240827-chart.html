<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/all.min.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/myall.css" />
    <title>chart.js</title>
  </head>
  <body>
    <!-- 選單 -->
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">會員報表</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="#">Home</a>
            </li>
            <li class="nav-item d-none me-2" id="s02_login_icon">
              <span class="h3 text-color02"
                ><i class="fa-solid fa-user"></i
                ><span class="h5" id="login_username_message"></span
              ></span>
            </li>
            <li class="nav-item d-none" id="s02_logout_button">
              <a class="nav-link" href="#" data-bs-toggle="modal"
                ><i class="fa-solid fa-right-from-bracket me-2"></i>登出</a
              >
            </li>
          </ul>
          <form class="d-flex" role="search">
            <input
              class="form-control me-2"
              type="search"
              placeholder="Search"
              aria-label="Search"
            />
            <button class="btn btn-outline-success" type="submit">
              Search
            </button>
          </form>
        </div>
      </div>
    </nav>
    <section>
        <div class="container my-3" id="member_total">
            <div class="row">
                <div class="col-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4>會員總數</h4>
                            <h2>123</h2>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4>已停權人員總數</h4>
                            <h2>123</h2>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4>啟用會員總數</h4>
                            <h2>123</h2>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4>一般會員數量</h4>
                            <h2>123</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container my-3">
            <div class="row">
              <div class="col-7">
                <div class="card text-center h-100">
                  <div class="card-body">
                    <div class="row ">
                      <div class="col-4 m-auto">
                        <select name="level_type" id="level_type" class="form-select">
                          <option value="line">線條圖</option>
                          <option value="pie">圓餅圖</option>
                          <option value="bar">長條圖</option>
                        </select>
                      </div>
                    </div>
                    <canvas id="myChart01" class="mt-5"></canvas>
                  </div>
                </div>
               </div>
               <div class="col-5">
                <div class="card text-center h-100">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-4 m-auto">
                        <select name="state_type" id="state_type" class="form-select">
                          <option value="pie">圓餅圖</option>
                          <option value="bar">長條圖</option>
                        </select>
                      </div>
                    </div>
                    <canvas id="myChart02" class=""></canvas>
                  </div>
                </div>
               </div>
            </div>
          </div>
    </section>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/sweetalert2@11.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      var mychart01;
      var mychart02;

      $(function () {
        if (getCookie("uid01") != "") {
          //將uid傳遞至後端api確認是否合法
          var dataJSON = {};
          dataJSON["uid01"] = getCookie("uid01");
          // //console.log(JSON.stringify(dataJSON));
          $.ajax({
            type: "POST",
            url: "API/member_login_check_uid_api.php",
            data: JSON.stringify(dataJSON),
            dataType: "json",
            success: showdata_check_uid,
            error: function () {
              alert("error-member_login_check_uid_api.php");
            },
          });
        } else {
          location.href = "index.html";
        }

        //監聽登出按鈕
        $("#s02_logout_button").click(function () {
          //將cookie設為空值
          setCookie("uid01", "", 7);
          //重整
          location.reload();
        });
      }); //end of main function

      function showdata_check_uid(data) {
        if (data.state) {
          if (data.data.Level == "900") {
            $("#login_username_message").text(data.data.Username + "您好");
            //顯示登出按鈕
            $("#s02_logout_button").removeClass("d-none");
            $("#s02_login_icon").removeClass("d-none");
            //
            $("#member_table").removeClass("d-none");

            //取得資料
            $.ajax({
              type: "GET",
              url: "API/member_chart.php",
              dataType: "json",
              success: showdata_chart,
              error: function () {
                alert("error_member_chart.php");
              },
            });
            //取得資料
            $.ajax({
              type: "GET",
              url: "API/member_chart_state.php",
              dataType: "json",
              success: showdata_chart_state,
              error: function () {
                alert("error_member_chart.php");
              },
            });

            //會員階級圖表
            const ctx = $("#myChart01"); //=document.getElementById
            mychart01 = new Chart(ctx, {
              type: "line",
              data: {
                labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
                datasets: [
                  {
                    label: "各層級會員人數",
                    data: [150, 19, 3, 5, 2, 3],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                  },
                },
              },
            });

            //會員階級圖表類型監聽
            $("#level_type").change(function () {
                ////console.log($(this).val());
                //先清空背景色與邊線顏色
                mychart01.data.datasets[0].backgroundColor=[];
                mychart01.data.datasets[0].borderColor=[];

                if($(this).val() == "line"){
                    mychart01.config.type = "line";
                }else{
                    // 設置共同的背景色和邊框色
                    //todo 顏色
                    const backgroundColors = [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 205, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(201, 203, 207, 0.2)'
                    ];
                    const borderColors = [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)'
                    ];
                    mychart01.data.datasets[0].backgroundColor = backgroundColors;
                    mychart01.data.datasets[0].borderColor = borderColors;

                    if($(this).val() == "bar"){
                        mychart01.config.type = "bar";
                        mychart01.config.options = {};
                    }else{
                    // 預設為 "pie" 類型
                        mychart01.config.type = "pie";
                        mychart01.config.options = {};
                    }
                }
              mychart01.update();
            });

            //會員是否停權圖表
            const ctx02 = $("#myChart02");
            mychart02 = new Chart(ctx02, {
              type: "pie",
              data: {
                labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
                datasets: [
                  {
                    label: "停權會員人數",
                    data: [150, 19, 3, 5, 2, 3],
                    borderWidth: 1,
                    backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 205, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(201, 203, 207, 0.2)'
                    ],
                    borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)'
                    ],
                  },
                ],
              },
            });

            //會員停權圖表類型監聽
            $("#state_type").change(function () {
                //console.log($(this).val());
                //先清空背景色與邊線顏色
                    if($(this).val() == "bar"){
                        mychart02.config.type = "bar";
                        mychart02.config.options = {};
                    }else{
                    // 預設為 "pie" 類型
                        mychart02.config.type = "pie";
                        mychart02.config.options = {};
                        
                    }
              mychart02.update();
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "管理員專用",
            }).then((result) => {
              if (result.isConfirmed) {
                location.href = "index.html";
              }
            });
          }
        }
      }

      function showdata_chart(data) {
        //console.log(data);

        //清空圖表
        mychart01.data.labels = [];
        mychart01.data.datasets[0].data = [];

        data.data.forEach(function (item) {
          //console.log(item.level);
          //console.log(item.level_num);
          if (item.level == "0") {
            mylevel = "一般會員";
          } else if (item.level == "100") {
            mylevel = "vip1";
          } else if (item.level == "200") {
            mylevel = "vip2";
          } else if (item.level == "300") {
            mylevel = "vip3";
          } else {
            mylevel = "管理員";
          }
          mychart01.data.labels.push(mylevel);
          mychart01.data.datasets[0].data.push(item.level_num);
          mychart01.update();
        });
      }

      function showdata_chart_state(data){
        //console.log(data);

        //清空圖表
        mychart02.data.labels = [];
        mychart02.data.datasets[0].data = [];

        data.data.forEach(function (item) {
          //console.log(item.state);
          //console.log(item.state_num);
          if (item.state == "0") {
            mystate = "停權";
          } else {
            mystate = "啟用";
          }
          mychart02.data.labels.push(mystate);
          mychart02.data.datasets[0].data.push(item.state_num);
          mychart02.update();
        });
        $("#member_total").empty();
        num1=Number(data.data[0].state_num);
        num2=Number(data.data[1].state_num);
        sum=(num1+num2);
        var strHTML='<div class="row"><div class="col-4"><div class="card text-center"><div class="card-body"><h4>會員總數</h4><h2>'+sum+'</h2></div></div></div><div class="col-4"><div class="card text-center"><div class="card-body"><h4>已停權人數</h4><h2>'+data.data[0].state_num+'</h2></div></div></div><div class="col-4"><div class="card text-center"><div class="card-body"><h4>啟用會員總數</h4><h2>'+data.data[1].state_num+'</h2></div></div></div>';
        $("#member_total").append(strHTML);
      }

      //**************cookie function from w3*****************
      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }
    </script>
  </body>
</html>
